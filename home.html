<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RPI Dining â€” Ship Log</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Orbitron:wght@400;700&display=swap');

    :root {
      --bg: #050d10;
      --bg2: #0b1e26;
      --node-bg: #0f2a35;
      --node-border: #1e5a72;
      --node-glow: #2a9fc9;
      --orange: #ff7d25;
      --orange-dim: #a84e10;
      --yellow: #f0c060;
      --green: #4caf7a;
      --text: #c8e8f0;
      --text-dim: #5a8a9a;
      --line: #1a4a5a;
      --line-glow: #2a9fc944;
      --sage-color: #7db87d;
      --commons-color: #e88a3a;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Space Mono', monospace;
      height: 100vh;
      overflow: hidden;
      cursor: crosshair;
    }

    /* â”€â”€ Starfield â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #starfield {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    /* â”€â”€ HUD header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #hud {
      position: fixed;
      top: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: linear-gradient(to bottom, #050d10dd, transparent);
      z-index: 100;
      pointer-events: none;
    }

    #hud .title {
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      letter-spacing: 4px;
      color: var(--text-dim);
      text-transform: uppercase;
    }

    #hud .title span {
      color: var(--orange);
    }

    #hud .date {
      font-size: 10px;
      color: var(--text-dim);
      letter-spacing: 2px;
    }

    #hud .mode-label {
      font-size: 10px;
      color: var(--node-glow);
      letter-spacing: 3px;
      animation: pulse-text 2s ease-in-out infinite;
    }

    @keyframes pulse-text {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    /* â”€â”€ Canvas viewport â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #viewport {
      position: fixed;
      inset: 0;
      z-index: 1;
      overflow: hidden;
    }

    #map {
      position: absolute;
      width: 3000px;
      height: 2000px;
      transform-origin: 0 0;
      cursor: grab;
      user-select: none;
    }

    #map.dragging { cursor: grabbing; }

    /* â”€â”€ SVG connections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #connections {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: visible;
    }

    /* â”€â”€ Node styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .node {
      position: absolute;
      background: var(--node-bg);
      border: 1px solid var(--node-border);
      border-radius: 4px;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
      transform-origin: center center;
    }

    .node:hover {
      border-color: var(--node-glow);
      box-shadow: 0 0 16px var(--line-glow), inset 0 0 20px rgba(42, 159, 201, 0.05);
      transform: scale(1.04);
    }

    .node.expanded {
      z-index: 50;
    }

    /* Hub node */
    .node-hub {
      width: 160px;
      padding: 14px 16px;
      border: 1px solid var(--node-glow);
      box-shadow: 0 0 24px rgba(42, 159, 201, 0.25), 0 0 60px rgba(42, 159, 201, 0.08);
      text-align: center;
    }

    .node-hub .hub-icon {
      font-size: 22px;
      margin-bottom: 6px;
      display: block;
    }

    .node-hub .hub-label {
      font-family: 'Orbitron', monospace;
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--node-glow);
      text-transform: uppercase;
    }

    /* Dining hall node */
    .node-hall {
      width: 140px;
      padding: 12px 14px;
    }

    .node-hall.commons { border-color: var(--commons-color); }
    .node-hall.commons:hover { box-shadow: 0 0 16px rgba(232, 138, 58, 0.35); }
    .node-hall.sage { border-color: var(--sage-color); }
    .node-hall.sage:hover { box-shadow: 0 0 16px rgba(125, 184, 125, 0.35); }

    .hall-icon {
      font-size: 16px;
      margin-bottom: 4px;
      display: block;
    }

    .hall-name {
      font-family: 'Orbitron', monospace;
      font-size: 8px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .hall-name.commons { color: var(--commons-color); }
    .hall-name.sage { color: var(--sage-color); }

    .hall-sub {
      font-size: 8px;
      color: var(--text-dim);
      letter-spacing: 1px;
    }

    /* Meal period node */
    .node-meal {
      width: 130px;
      padding: 10px 12px;
    }

    .meal-period {
      font-family: 'Orbitron', monospace;
      font-size: 8px;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .meal-hours {
      font-size: 8px;
      color: var(--text-dim);
      letter-spacing: 0.5px;
    }

    .meal-indicator {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }

    .meal-indicator.active {
      background: var(--green);
      box-shadow: 0 0 6px var(--green);
      animation: blink 1.4s ease-in-out infinite;
    }

    .meal-indicator.inactive { background: var(--text-dim); }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .expand-hint {
      font-size: 7px;
      color: var(--orange);
      letter-spacing: 1px;
      margin-top: 6px;
      opacity: 0.7;
    }

    /* â”€â”€ Expanded panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .node-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.92);
      width: min(680px, 94vw);
      max-height: 80vh;
      background: #07181f;
      border: 1px solid var(--node-glow);
      border-radius: 6px;
      box-shadow: 0 0 60px rgba(42, 159, 201, 0.2), 0 0 120px rgba(42, 159, 201, 0.06);
      z-index: 200;
      display: none;
      flex-direction: column;
      opacity: 0;
      transition: opacity 0.25s, transform 0.25s;
      overflow: hidden;
    }

    .node-panel.visible {
      display: flex;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid var(--node-border);
      flex-shrink: 0;
    }

    .panel-title {
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    .panel-title.commons { color: var(--commons-color); }
    .panel-title.sage { color: var(--sage-color); }
    .panel-title.lunch { color: var(--yellow); }
    .panel-title.dinner { color: var(--orange); }

    .panel-close {
      background: none;
      border: 1px solid var(--node-border);
      color: var(--text-dim);
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      padding: 4px 10px;
      cursor: pointer;
      letter-spacing: 1px;
      transition: border-color 0.2s, color 0.2s;
    }

    .panel-close:hover {
      border-color: var(--orange);
      color: var(--orange);
    }

    .panel-body {
      padding: 18px;
      overflow-y: auto;
      flex: 1;
    }

    .panel-body::-webkit-scrollbar { width: 4px; }
    .panel-body::-webkit-scrollbar-track { background: var(--bg2); }
    .panel-body::-webkit-scrollbar-thumb { background: var(--node-border); }

    .panel-section {
      margin-bottom: 18px;
    }

    .panel-section-title {
      font-family: 'Orbitron', monospace;
      font-size: 8px;
      letter-spacing: 2px;
      color: var(--text-dim);
      text-transform: uppercase;
      border-bottom: 1px solid var(--node-border);
      padding-bottom: 4px;
      margin-bottom: 10px;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 8px;
    }

    .menu-item {
      background: #0b1e2688;
      border: 1px solid #1a3a4a;
      border-radius: 3px;
      padding: 8px 10px;
      font-size: 9px;
      line-height: 1.5;
      letter-spacing: 0.5px;
      transition: border-color 0.2s;
    }

    .menu-item:hover { border-color: var(--node-glow); }

    .menu-item-name {
      color: var(--text);
      margin-bottom: 2px;
    }

    .menu-item-tags {
      color: var(--text-dim);
      font-size: 8px;
    }

    .tag {
      display: inline-block;
      padding: 1px 4px;
      border-radius: 2px;
      margin-right: 3px;
      font-size: 7px;
      letter-spacing: 0.5px;
    }

    .tag.veg { background: #1a3a1a; color: var(--green); border: 1px solid #2a5a2a; }
    .tag.vegan { background: #1a3a1a; color: #7dd47d; border: 1px solid #2a5a2a; }
    .tag.halal { background: #1a2a3a; color: #7db8d8; border: 1px solid #2a4a6a; }

    .hours-row {
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      padding: 5px 0;
      border-bottom: 1px solid #0e2a35;
      letter-spacing: 0.5px;
    }

    .hours-row .day { color: var(--text-dim); }
    .hours-row .time { color: var(--text); }

    .panel-link {
      display: inline-block;
      margin-top: 12px;
      font-size: 9px;
      color: var(--node-glow);
      text-decoration: none;
      border: 1px solid var(--node-border);
      padding: 6px 12px;
      letter-spacing: 1px;
      transition: border-color 0.2s, color 0.2s;
    }

    .panel-link:hover {
      border-color: var(--node-glow);
      color: var(--yellow);
    }

    .loading-text {
      font-size: 9px;
      color: var(--text-dim);
      letter-spacing: 2px;
      animation: pulse-text 1.5s ease-in-out infinite;
    }

    .menu-status {
      font-size: 9px;
      padding: 5px 8px;
      border-radius: 3px;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
    }

    .menu-status.open { background: #0a2a15; border: 1px solid #1a5a25; color: var(--green); }
    .menu-status.closed { background: #2a0a0a; border: 1px solid #5a1a1a; color: #e06060; }

    /* â”€â”€ Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 150;
      display: none;
    }

    #overlay.visible { display: block; }

    /* â”€â”€ Zoom controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .ctrl-btn {
      width: 30px;
      height: 30px;
      background: var(--node-bg);
      border: 1px solid var(--node-border);
      color: var(--text);
      font-family: 'Space Mono', monospace;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.15s;
    }

    .ctrl-btn:hover { border-color: var(--node-glow); }

    /* â”€â”€ Mini legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #legend {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 100;
      font-size: 8px;
      color: var(--text-dim);
      letter-spacing: 1px;
    }

    #legend .l-row { margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    #legend .l-dot {
      width: 6px; height: 6px; border-radius: 50%;
      box-shadow: 0 0 4px currentColor;
    }

    /* â”€â”€ Scan line effect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #scanlines {
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        to bottom,
        transparent,
        transparent 2px,
        rgba(0,0,0,0.04) 2px,
        rgba(0,0,0,0.04) 4px
      );
      pointer-events: none;
      z-index: 300;
    }

    /* â”€â”€ Corner decorations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .corner {
      position: fixed;
      width: 30px;
      height: 30px;
      z-index: 100;
      pointer-events: none;
    }

    .corner::before, .corner::after {
      content: '';
      position: absolute;
      background: var(--node-glow);
    }

    .corner::before { width: 1px; height: 100%; }
    .corner::after { width: 100%; height: 1px; }

    .corner-tl { top: 10px; left: 10px; }
    .corner-tr { top: 10px; right: 10px; transform: scaleX(-1); }
    .corner-bl { bottom: 10px; left: 10px; transform: scaleY(-1); }
    .corner-br { bottom: 10px; right: 10px; transform: scale(-1); }
  </style>
</head>
<body>

<canvas id="starfield"></canvas>
<div id="scanlines"></div>

<div class="corner corner-tl"></div>
<div class="corner corner-tr"></div>
<div class="corner corner-bl"></div>
<div class="corner corner-br"></div>

<div id="hud">
  <div class="title">RPI <span>Dining</span> â€” Ship Log</div>
  <div class="mode-label">RUMOR MODE</div>
  <div class="date" id="hud-date"></div>
</div>

<div id="viewport">
  <div id="map">
    <svg id="connections" xmlns="http://www.w3.org/2000/svg"></svg>

    <!-- Central hub -->
    <div class="node node-hub" id="node-hub" style="left:1420px; top:900px;">
      <span class="hub-icon">â—ˆ</span>
      <div class="hub-label">Today's Dining</div>
    </div>
    <!-- Commons dining hall -->
    <div class="node node-hall commons" id="node-commons" style="left:1150px; top:700px;" onclick="openPanel('panel-commons')">
      <span class="hall-icon">ğŸ›</span>
      <div class="hall-name commons">The Commons</div>
      <div class="hall-sub">Dining Hall</div>
    </div>

    <!-- Russell Sage dining hall -->
    <div class="node node-hall sage" id="node-sage" style="left:1700px; top:700px;" onclick="openPanel('panel-sage')">
      <span class="hall-icon">ğŸ›</span>
      <div class="hall-name sage">Russell Sage</div>
      <div class="hall-sub">Dining Hall</div>
    </div>

    <!-- Commons meals -->
    <div class="node node-meal" id="node-commons-lunch" style="left:1000px; top:550px;" onclick="openPanel('panel-commons-lunch')">
      <div class="meal-period" style="color:var(--yellow)">
        <span class="meal-indicator" id="ind-commons-lunch"></span>Lunch
      </div>
      <div class="meal-hours">11:00 AM â€“ 3:30 PM</div>
      <div class="expand-hint">â–¶ TAP TO EXPAND</div>
    </div>

    <div class="node node-meal" id="node-commons-dinner" style="left:1000px; top:680px;" onclick="openPanel('panel-commons-dinner')">
      <div class="meal-period" style="color:var(--orange)">
        <span class="meal-indicator" id="ind-commons-dinner"></span>Dinner
      </div>
      <div class="meal-hours">4:30 PM â€“ 9:00 PM</div>
      <div class="expand-hint">â–¶ TAP TO EXPAND</div>
    </div>

    <!-- Sage meals -->
    <div class="node node-meal" id="node-sage-lunch" style="left:1840px; top:550px;" onclick="openPanel('panel-sage-lunch')">
      <div class="meal-period" style="color:var(--yellow)">
        <span class="meal-indicator" id="ind-sage-lunch"></span>Lunch
      </div>
      <div class="meal-hours">11:00 AM â€“ 2:30 PM</div>
      <div class="expand-hint">â–¶ TAP TO EXPAND</div>
    </div>

    <div class="node node-meal" id="node-sage-dinner" style="left:1840px; top:680px;" onclick="openPanel('panel-sage-dinner')">
      <div class="meal-period" style="color:var(--orange)">
        <span class="meal-indicator" id="ind-sage-dinner"></span>Dinner
      </div>
      <div class="meal-hours">4:00 PM â€“ 8:00 PM</div>
      <div class="expand-hint">â–¶ TAP TO EXPAND</div>
    </div>

  </div>
</div>

<!-- Overlay -->
<div id="overlay" onclick="closeAllPanels()"></div>

<!-- â”€â”€ Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<!-- Commons Hall Info -->
<div class="node-panel" id="panel-commons">
  <div class="panel-header">
    <div class="panel-title commons">The Commons Dining Hall</div>
    <button class="panel-close" onclick="closeAllPanels()">[ CLOSE ]</button>
  </div>
  <div class="panel-body">
    <div class="panel-section">
      <div class="panel-section-title">Location</div>
      <div style="font-size:9px;line-height:1.8;color:var(--text-dim)">
        1999 Burdett Ave, Troy, NY 12180<br>
        Style: All-You-Care-To-Eat buffet<br>
        Features: Simple Zone (allergen-free section), nutrition labels
      </div>
    </div>
    <div class="panel-section">
      <div class="panel-section-title">Hours of Operation</div>
      <div class="hours-row"><span class="day">Monâ€“Fri Lunch</span><span class="time">11:00 AM â€“ 3:30 PM</span></div>
      <div class="hours-row"><span class="day">Monâ€“Sun Dinner</span><span class="time">4:30 PM â€“ 9:00 PM</span></div>
      <div class="hours-row"><span class="day">Satâ€“Sun Late Lunch</span><span class="time">2:00 PM â€“ 4:30 PM</span></div>
    </div>
    <a class="panel-link" href="https://rpi.sodexomyway.com/en-us/locations/the-commons-dining-hall" target="_blank">
      â—ˆ VIEW FULL MENU â†’
    </a>
  </div>
</div>

<!-- Sage Hall Info -->
<div class="node-panel" id="panel-sage">
  <div class="panel-header">
    <div class="panel-title sage">Russell Sage Dining Hall</div>
    <button class="panel-close" onclick="closeAllPanels()">[ CLOSE ]</button>
  </div>
  <div class="panel-body">
    <div class="panel-section">
      <div class="panel-section-title">Location</div>
      <div style="font-size:9px;line-height:1.8;color:var(--text-dim)">
        Troy, NY 12180 (heart of academic campus)<br>
        Style: Convenient buffet-style resident dining<br>
        Features: Dietary filters (veg, vegan, mindful, plant-based)
      </div>
    </div>
    <div class="panel-section">
      <div class="panel-section-title">Hours of Operation</div>
      <div class="hours-row"><span class="day">Monâ€“Fri Breakfast</span><span class="time">7:00 AM â€“ 10:00 AM</span></div>
      <div class="hours-row"><span class="day">Monâ€“Fri Lunch</span><span class="time">11:00 AM â€“ 2:30 PM</span></div>
      <div class="hours-row"><span class="day">Monâ€“Fri Late Lunch</span><span class="time">2:30 PM â€“ 4:00 PM</span></div>
      <div class="hours-row"><span class="day">Monâ€“Sun Dinner</span><span class="time">4:00 PM â€“ 8:00 PM</span></div>
      <div class="hours-row"><span class="day">Satâ€“Sun Late Lunch</span><span class="time">1:30 PM â€“ 4:00 PM</span></div>
    </div>
    <a class="panel-link" href="https://rpi.sodexomyway.com/en-us/locations/russell-sage-dining-hall" target="_blank">
      â—ˆ VIEW FULL MENU â†’
    </a>
  </div>
</div>

<!-- Commons Lunch -->
<div class="node-panel" id="panel-commons-lunch">
  <div class="panel-header">
    <div class="panel-title lunch">Commons â€” Lunch</div>
    <button class="panel-close" onclick="closeAllPanels()">[ CLOSE ]</button>
  </div>
  <div class="panel-body">
    <div class="menu-status" id="status-commons-lunch"></div>
    <div class="panel-section">
      <div class="panel-section-title">Hours</div>
      <div class="hours-row"><span class="day">Monâ€“Fri</span><span class="time">11:00 AM â€“ 3:30 PM</span></div>
      <div class="hours-row"><span class="day">Satâ€“Sun</span><span class="time">Late Lunch: 2:00 PM â€“ 4:30 PM</span></div>
    </div>
    <div class="panel-section">
      <div class="panel-section-title">Today's Menu</div>
      <div id="menu-commons-lunch" class="menu-grid">
        <div class="loading-text">LOADING MENU DATA...</div>
      </div>
    </div>
    <a class="panel-link" href="https://rpi.sodexomyway.com/en-us/locations/the-commons-dining-hall" target="_blank">
      â—ˆ VIEW ON SODEXO â†’
    </a>
  </div>
</div>

<!-- Commons Dinner -->
<div class="node-panel" id="panel-commons-dinner">
  <div class="panel-header">
    <div class="panel-title dinner">Commons â€” Dinner</div>
    <button class="panel-close" onclick="closeAllPanels()">[ CLOSE ]</button>
  </div>
  <div class="panel-body">
    <div class="menu-status" id="status-commons-dinner"></div>
    <div class="panel-section">
      <div class="panel-section-title">Hours</div>
      <div class="hours-row"><span class="day">Monâ€“Sun</span><span class="time">4:30 PM â€“ 9:00 PM</span></div>
    </div>
    <div class="panel-section">
      <div class="panel-section-title">Today's Menu</div>
      <div id="menu-commons-dinner" class="menu-grid">
        <div class="loading-text">LOADING MENU DATA...</div>
      </div>
    </div>
    <a class="panel-link" href="https://rpi.sodexomyway.com/en-us/locations/the-commons-dining-hall" target="_blank">
      â—ˆ VIEW ON SODEXO â†’
    </a>
  </div>
</div>

<!-- Sage Lunch -->
<div class="node-panel" id="panel-sage-lunch">
  <div class="panel-header">
    <div class="panel-title lunch">Russell Sage â€” Lunch</div>
    <button class="panel-close" onclick="closeAllPanels()">[ CLOSE ]</button>
  </div>
  <div class="panel-body">
    <div class="menu-status" id="status-sage-lunch"></div>
    <div class="panel-section">
      <div class="panel-section-title">Hours</div>
      <div class="hours-row"><span class="day">Monâ€“Fri</span><span class="time">11:00 AM â€“ 2:30 PM</span></div>
      <div class="hours-row"><span class="day">Satâ€“Sun</span><span class="time">Late Lunch: 1:30 PM â€“ 4:00 PM</span></div>
    </div>
    <div class="panel-section">
      <div class="panel-section-title">Today's Menu</div>
      <div id="menu-sage-lunch" class="menu-grid">
        <div class="loading-text">LOADING MENU DATA...</div>
      </div>
    </div>
    <a class="panel-link" href="https://rpi.sodexomyway.com/en-us/locations/russell-sage-dining-hall" target="_blank">
      â—ˆ VIEW ON SODEXO â†’
    </a>
  </div>
</div>

<!-- Sage Dinner -->
<div class="node-panel" id="panel-sage-dinner">
  <div class="panel-header">
    <div class="panel-title dinner">Russell Sage â€” Dinner</div>
    <button class="panel-close" onclick="closeAllPanels()">[ CLOSE ]</button>
  </div>
  <div class="panel-body">
    <div class="menu-status" id="status-sage-dinner"></div>
    <div class="panel-section">
      <div class="panel-section-title">Hours</div>
      <div class="hours-row"><span class="day">Monâ€“Sun</span><span class="time">4:00 PM â€“ 8:00 PM</span></div>
    </div>
    <div class="panel-section">
      <div class="panel-section-title">Today's Menu</div>
      <div id="menu-sage-dinner" class="menu-grid">
        <div class="loading-text">LOADING MENU DATA...</div>
      </div>
    </div>
    <a class="panel-link" href="https://rpi.sodexomyway.com/en-us/locations/russell-sage-dining-hall" target="_blank">
      â—ˆ VIEW ON SODEXO â†’
    </a>
  </div>
</div>

<!-- Zoom controls -->
<div id="controls">
  <button class="ctrl-btn" onclick="zoom(0.15)">+</button>
  <button class="ctrl-btn" onclick="zoom(-0.15)">âˆ’</button>
  <button class="ctrl-btn" onclick="resetView()" style="font-size:9px;letter-spacing:0;">âŒ–</button>
</div>

<!-- Legend -->
<div id="legend">
  <div class="l-row"><span class="l-dot" style="color:var(--node-glow);background:var(--node-glow)"></span>Hub</div>
  <div class="l-row"><span class="l-dot" style="color:var(--commons-color);background:var(--commons-color)"></span>Commons</div>
  <div class="l-row"><span class="l-dot" style="color:var(--sage-color);background:var(--sage-color)"></span>Sage</div>
  <div class="l-row"><span class="l-dot" style="color:var(--green);background:var(--green)"></span>Open now</div>
</div>

<script>
// â”€â”€ Starfield â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('starfield');
const ctx = canvas.getContext('2d');
let stars = [];

function initStars() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  stars = [];
  for (let i = 0; i < 200; i++) {
    stars.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      r: Math.random() * 1.2,
      a: Math.random(),
      speed: 0.0003 + Math.random() * 0.0005
    });
  }
}

function drawStars() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const t = Date.now();
  stars.forEach(s => {
    const alpha = 0.2 + 0.5 * Math.sin(t * s.speed + s.a * 100);
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(160, 210, 230, ${alpha})`;
    ctx.fill();
  });
  requestAnimationFrame(drawStars);
}

window.addEventListener('resize', initStars);
initStars();
drawStars();

// â”€â”€ HUD date â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const now = new Date();
const days = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
document.getElementById('hud-date').textContent =
  `${days[now.getDay()]} ${months[now.getMonth()]} ${now.getDate()} â€” ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

// â”€â”€ Active meal indicators â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setIndicator(id, isOpen) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.toggle('active', isOpen);
  el.classList.toggle('inactive', !isOpen);
}

function checkMealTimes() {
  const h = now.getHours() + now.getMinutes() / 60;
  const dow = now.getDay(); // 0=Sun, 6=Sat
  const isWeekday = dow >= 1 && dow <= 5;
  const isWeekend = dow === 0 || dow === 6;

  // Commons lunch: weekday 11-15.5, weekend late lunch 14-16.5
  const commonsLunch = isWeekday ? (h >= 11 && h < 15.5) : (h >= 14 && h < 16.5);
  // Commons dinner: every day 16.5-21
  const commonsDinner = h >= 16.5 && h < 21;
  // Sage lunch: weekday 11-14.5, weekend late 13.5-16
  const sageLunch = isWeekday ? (h >= 11 && h < 14.5) : (h >= 13.5 && h < 16);
  // Sage dinner: every day 16-20
  const sageDinner = h >= 16 && h < 20;

  setIndicator('ind-commons-lunch', commonsLunch);
  setIndicator('ind-commons-dinner', commonsDinner);
  setIndicator('ind-sage-lunch', sageLunch);
  setIndicator('ind-sage-dinner', sageDinner);

  // Panel status
  setMealStatus('status-commons-lunch', commonsLunch, '11:00 AM â€“ 3:30 PM');
  setMealStatus('status-commons-dinner', commonsDinner, '4:30 PM â€“ 9:00 PM');
  setMealStatus('status-sage-lunch', sageLunch, '11:00 AM â€“ 2:30 PM');
  setMealStatus('status-sage-dinner', sageDinner, '4:00 PM â€“ 8:00 PM');
}

function setMealStatus(id, isOpen, hours) {
  const el = document.getElementById(id);
  if (!el) return;
  if (isOpen) {
    el.className = 'menu-status open';
    el.textContent = `â— OPEN NOW  Â·  ${hours}`;
  } else {
    el.className = 'menu-status closed';
    el.textContent = `â—‹ CLOSED  Â·  Opens ${hours}`;
  }
}

checkMealTimes();

// â”€â”€ SVG connections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nodePositions = {
  hub:           { x: 1420 + 80,  y: 900 + 36  },
  commons:       { x: 1150 + 70,  y: 700 + 42  },
  sage:          { x: 1700 + 70,  y: 700 + 42  },
  'commons-lunch':  { x: 1000 + 65,  y: 550 + 36  },
  'commons-dinner': { x: 1000 + 65,  y: 680 + 36  },
  'sage-lunch':     { x: 1840 + 65,  y: 550 + 36  },
  'sage-dinner':    { x: 1840 + 65,  y: 680 + 36  },
};

const edges = [
  ['hub', 'commons', '#1e5a72'],
  ['hub', 'sage', '#1e5a72'],
  ['commons', 'commons-lunch', '#7a4a1e'],
  ['commons', 'commons-dinner', '#7a4a1e'],
  ['sage', 'sage-lunch', '#1e5a2e'],
  ['sage', 'sage-dinner', '#1e5a2e'],
];

function drawConnections() {
  const svg = document.getElementById('connections');
  svg.innerHTML = '';

  // Defs for glow filter
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  defs.innerHTML = `
    <filter id="glow">
      <feGaussianBlur stdDeviation="3" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
  `;
  svg.appendChild(defs);

  edges.forEach(([from, to, color]) => {
    const a = nodePositions[from];
    const b = nodePositions[to];
    const mx = (a.x + b.x) / 2;
    const my = (a.y + b.y) / 2;

    // Glow line (wider, blurred)
    const glow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    const d = `M ${a.x} ${a.y} Q ${mx} ${a.y} ${b.x} ${b.y}`;
    glow.setAttribute('d', d);
    glow.setAttribute('stroke', color);
    glow.setAttribute('stroke-width', '4');
    glow.setAttribute('fill', 'none');
    glow.setAttribute('opacity', '0.3');
    glow.setAttribute('filter', 'url(#glow)');
    svg.appendChild(glow);

    // Main line
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    line.setAttribute('d', d);
    line.setAttribute('stroke', color);
    line.setAttribute('stroke-width', '1.5');
    line.setAttribute('fill', 'none');
    line.setAttribute('opacity', '0.9');
    svg.appendChild(line);

    // Animated dot
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('r', '2.5');
    circle.setAttribute('fill', color);
    circle.setAttribute('opacity', '0.8');

    const anim = document.createElementNS('http://www.w3.org/2000/svg', 'animateMotion');
    anim.setAttribute('dur', `${3 + Math.random() * 3}s`);
    anim.setAttribute('repeatCount', 'indefinite');
    anim.setAttribute('keyTimes', '0;1');
    anim.setAttribute('keySplines', '.25 0 .75 1');
    anim.setAttribute('calcMode', 'spline');
    const mp = document.createElementNS('http://www.w3.org/2000/svg', 'mpath');
    // Use an inline path for animateMotion
    anim.setAttribute('path', d);
    circle.appendChild(anim);
    svg.appendChild(circle);
  });
}

drawConnections();

// â”€â”€ Pan & Zoom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = document.getElementById('map');
const viewport = document.getElementById('viewport');
let scale = 0.45;
let panX = 0, panY = 0;
let dragging = false;
let startX, startY, startPanX, startPanY;

function applyTransform() {
  map.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
}

function centerMap() {
  // Center on hub node
  const hub = nodePositions.hub;
  const vw = viewport.clientWidth;
  const vh = viewport.clientHeight;
  panX = vw / 2 - hub.x * scale;
  panY = vh / 2 - hub.y * scale;
  applyTransform();
}

function zoom(delta) {
  const newScale = Math.max(0.2, Math.min(2, scale + delta));
  const vw = viewport.clientWidth;
  const vh = viewport.clientHeight;
  const cx = vw / 2;
  const cy = vh / 2;
  panX = cx - (cx - panX) * (newScale / scale);
  panY = cy - (cy - panY) * (newScale / scale);
  scale = newScale;
  applyTransform();
}

function resetView() {
  scale = 0.45;
  centerMap();
}

viewport.addEventListener('mousedown', e => {
  if (e.target.closest('.node') || e.target.closest('.node-panel')) return;
  dragging = true;
  map.classList.add('dragging');
  startX = e.clientX;
  startY = e.clientY;
  startPanX = panX;
  startPanY = panY;
});

window.addEventListener('mousemove', e => {
  if (!dragging) return;
  panX = startPanX + e.clientX - startX;
  panY = startPanY + e.clientY - startY;
  applyTransform();
});

window.addEventListener('mouseup', () => {
  dragging = false;
  map.classList.remove('dragging');
});

viewport.addEventListener('wheel', e => {
  e.preventDefault();
  const zoomDelta = -e.deltaY * 0.001;
  const newScale = Math.max(0.2, Math.min(2, scale + zoomDelta * scale));
  const rect = viewport.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  panX = mx - (mx - panX) * (newScale / scale);
  panY = my - (my - panY) * (newScale / scale);
  scale = newScale;
  applyTransform();
}, { passive: false });

// Touch support
let lastTouchDist = null;
viewport.addEventListener('touchstart', e => {
  if (e.touches.length === 1) {
    dragging = true;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    startPanX = panX;
    startPanY = panY;
  }
}, { passive: true });

viewport.addEventListener('touchmove', e => {
  if (e.touches.length === 1 && dragging) {
    panX = startPanX + e.touches[0].clientX - startX;
    panY = startPanY + e.touches[0].clientY - startY;
    applyTransform();
  } else if (e.touches.length === 2) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    if (lastTouchDist) {
      const delta = (dist - lastTouchDist) * 0.003;
      scale = Math.max(0.2, Math.min(2, scale + delta));
      applyTransform();
    }
    lastTouchDist = dist;
  }
}, { passive: true });

viewport.addEventListener('touchend', () => {
  dragging = false;
  lastTouchDist = null;
});

// â”€â”€ Panel open/close â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPanel(id) {
  closeAllPanels();
  const panel = document.getElementById(id);
  if (!panel) return;
  document.getElementById('overlay').classList.add('visible');
  // Use setTimeout to allow display:flex to apply before transition
  setTimeout(() => panel.classList.add('visible'), 10);

  // Load menu if applicable
  if (id === 'panel-commons-lunch') loadMenu('commons', 'lunch', 'menu-commons-lunch');
  if (id === 'panel-commons-dinner') loadMenu('commons', 'dinner', 'menu-commons-dinner');
  if (id === 'panel-sage-lunch') loadMenu('sage', 'lunch', 'menu-sage-lunch');
  if (id === 'panel-sage-dinner') loadMenu('sage', 'dinner', 'menu-sage-dinner');
}

function closeAllPanels() {
  document.querySelectorAll('.node-panel').forEach(p => p.classList.remove('visible'));
  document.getElementById('overlay').classList.remove('visible');
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAllPanels(); });

// â”€â”€ Sodexo menu fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Sodexo uses: https://rpi.sodexomyway.com/api/menu?menuId=...&locationId=...&date=YYYY-MM-DD
// Known location/menu IDs for RPI
const SODEXO_IDS = {
  commons: { locationId: 22374, menuId: 9000007 },
  sage:    { locationId: 22375, menuId: 9000007 },
};

const MEAL_NAMES = {
  lunch: ['lunch', 'Lunch', 'LUNCH'],
  dinner: ['dinner', 'Dinner', 'DINNER', 'Supper'],
};

async function loadMenu(hall, meal, targetId) {
  const container = document.getElementById(targetId);
  if (!container) return;
  container.innerHTML = '<div class="loading-text">QUERYING DINING DATABASE...</div>';

  const today = new Date().toISOString().split('T')[0];
  const url = `menu-proxy.php?hall=${hall}&date=${today}`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('proxy error');
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    renderMenu(data, meal, container);
  } catch (err) {
    container.innerHTML = `
      <div style="font-size:9px;color:var(--text-dim);line-height:1.8;grid-column:1/-1">
        <div style="color:var(--orange);margin-bottom:8px;">âš  MENU UNAVAILABLE</div>
        Could not load menu data. Check the Sodexo site directly.<br>
        <small style="color:var(--text-dim);opacity:0.6">${err.message}</small>
      </div>
    `;
  }
}

function renderMenu(data, meal, container) {
  // Parse Sodexo's JSON structure â€” they nest under meal periods
  let items = [];

  // Try various known structures
  if (Array.isArray(data)) {
    data.forEach(day => {
      if (day.menu && Array.isArray(day.menu)) {
        day.menu.forEach(period => {
          if (MEAL_NAMES[meal].some(n => period.periodName && period.periodName.toLowerCase().includes(n.toLowerCase()))) {
            if (period.courses) {
              period.courses.forEach(course => {
                if (course.menuItems) items.push(...course.menuItems);
              });
            }
          }
        });
      }
    });
  } else if (data.menus) {
    data.menus.forEach(period => {
      if (MEAL_NAMES[meal].some(n => period.periodName && period.periodName.toLowerCase().includes(n.toLowerCase()))) {
        if (period.courses) {
          period.courses.forEach(course => {
            if (course.menuItems) items.push(...course.menuItems);
          });
        }
      }
    });
  }

  if (items.length === 0) {
    container.innerHTML = `<div style="font-size:9px;color:var(--text-dim);grid-column:1/-1">No menu items found for this period. <br>Check the Sodexo website for today's offerings.</div>`;
    return;
  }

  container.innerHTML = items.map(item => {
    const name = item.formalName || item.name || item.itemName || 'Unknown Item';
    const tags = [];
    if (item.isVegetarian || item.vegetarian) tags.push('<span class="tag veg">VEG</span>');
    if (item.isVegan || item.vegan) tags.push('<span class="tag vegan">VEGAN</span>');
    if (item.isHalal || item.halal) tags.push('<span class="tag halal">HALAL</span>');
    return `
      <div class="menu-item">
        <div class="menu-item-name">${name}</div>
        ${tags.length ? `<div class="menu-item-tags">${tags.join('')}</div>` : ''}
      </div>
    `;
  }).join('');
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
centerMap();
</script>
</body>
</html>
